--// CONFIG
local animationIds = {
	["rbxassetid://10503381238"] = true,
	["rbxassetid://13379003796"] = true,
}

local TWEEN_HEIGHT_OFFSET = Vector3.new(0, 4.9, 0)

--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")

--// VARIABLES
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local toggleConnection
local aimlockConnection
local lockedTarget = nil

--// AIMLOCK FUNCTION
local function startAimlock(target)
	if aimlockConnection then aimlockConnection:Disconnect() end

	local cam = Workspace.CurrentCamera
	local hrp = character:FindFirstChild("HumanoidRootPart")
	local startTime = tick()

	aimlockConnection = RunService.RenderStepped:Connect(function()
		if not (target and target:FindFirstChild("HumanoidRootPart")) then return end
		if not (character and hrp and hrp.Parent) then return end

		local now = tick()
		local targetPos = target.HumanoidRootPart.Position
		local camPos = cam.CFrame.Position

		if now - startTime < 0.15 then
			local angleX = math.rad(math.random(-15, 25))
			local angleY = math.rad(math.random(-15, 25))
			local baseCFrame = CFrame.new(camPos, targetPos)
			local newLook = baseCFrame * CFrame.Angles(angleY, angleX, 0)
			cam.CFrame = newLook
		else
			cam.CFrame = CFrame.new(camPos, targetPos)
		end

		hrp.CFrame = CFrame.new(hrp.Position, cam.CFrame.Position + cam.CFrame.LookVector)
	end)

	task.delay(0.65, function()
		if aimlockConnection then
			aimlockConnection:Disconnect()
			aimlockConnection = nil
			lockedTarget = nil
		end
	end)
end

--// MAIN CORE
local function setup(char)
	if toggleConnection then toggleConnection:Disconnect() end
	if aimlockConnection then aimlockConnection:Disconnect() end
	lockedTarget = nil

	local hrp = char:WaitForChild("HumanoidRootPart")
	local humanoid = char:WaitForChild("Humanoid")

	local isTweening = false
	local lastPlaying = false
	local cooldown = false

	toggleConnection = RunService.RenderStepped:Connect(function()
		local isPlaying = false
		for _, track in ipairs(humanoid:GetPlayingAnimationTracks()) do
			if track.Animation and animationIds[track.Animation.AnimationId] then
				isPlaying = true
				break
			end
		end

		if isPlaying and not isTweening and not lastPlaying and not cooldown then
			isTweening = true
			lastPlaying = true
			cooldown = true

			task.delay(0.18, function()
				local live = Workspace:FindFirstChild("Live")
				local target, shortest = nil, 6
				if live then
					for _, model in ipairs(live:GetChildren()) do
						if model:IsA("Model") and model ~= char then
							local root = model:FindFirstChild("HumanoidRootPart") or model:FindFirstChild("Head") or model:FindFirstChild("UpperTorso")
							if root then
								local dist = (hrp.Position - root.Position).Magnitude
								if dist < shortest then
									shortest = dist
									target = model
								end
							end
						end
					end
				end

				if target and target:FindFirstChild("HumanoidRootPart") then
					local targetPos = target.HumanoidRootPart.Position + TWEEN_HEIGHT_OFFSET
					local tween = TweenService:Create(hrp, TweenInfo.new(0.1, Enum.EasingStyle.Linear), {CFrame = CFrame.new(targetPos)})
					tween:Play()
					tween.Completed:Wait()

					local bp = Instance.new("BodyPosition")
					bp.MaxForce = Vector3.new(1e5, 1e5, 1e5)
					bp.P = 10000
					bp.D = 100
					bp.Position = targetPos
					bp.Parent = hrp
					game.Debris:AddItem(bp, 0.76)

					local remote = char:FindFirstChild("Communicate")
					if remote then
						remote:FireServer({
							{ Dash = Enum.KeyCode.W, Key = Enum.KeyCode.Q, Goal = "KeyPress" }
						})
					end

					lockedTarget = target
					startAimlock(target)
				end

				isTweening = false
				task.delay(4, function()
					cooldown = false
				end)
			end)
		elseif not isPlaying then
			lastPlaying = false
		end
	end)
end

--// BIND CHARACTER
player.CharacterAdded:Connect(function(char)
	character = char
	setup(char)
end)

if player.Character then
	setup(player.Character)
end
